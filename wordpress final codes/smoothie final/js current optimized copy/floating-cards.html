<script type="text/javascript">
  function floating_cards_animation() {
    // --- Prevent duplicate init ---
    if (window._floatingCardsMM) {
      window._floatingCardsMM.kill();
      window._floatingCardsMM = null;
    }
    window.removeEventListener("mousemove", window._floatingCardsMouseHandler);

    if (!document.querySelector("#floating-cards-section")) return;

    let windowX = window.innerWidth;
    let windowY = window.innerHeight;

    // --- GSAP matchMedia ---
    let mm = gsap.matchMedia();
    window._floatingCardsMM = mm; // store globally for cleanup

    mm.add("(orientation: portrait)", () => {
      buildTimelines("-15vw", "10vh", 2.5);
    });

    mm.add("(orientation: landscape)", () => {
      buildTimelines("-55vw", "18vh", 3.5);
    });

    // --- Timeline builder ---
    function buildTimelines(stickyCardFinalX, stickyCardFinalY, endMultiplier) {
      const sectionHeight = window.innerHeight;
      const stEnd = "+=" + sectionHeight * endMultiplier;

      // Intro timeline
      let tl = gsap.timeline({
        scrollTrigger: {
          trigger: "#floating-cards-section",
          start: "top bottom",
          end: "bottom bottom-=50%",
          scrub: 0.5,
          anticipatePin: 1,
        },
        defaults: { ease: "power2.in" },
      });

      tl.from(".floating-card", {
        z: "-5vw",
        opacity: 0,
        stagger: 0.01,
        onStart: () =>
          document
            .getElementById("floating-card-sticky")
            ?.classList.add("fc-far"),
      })
        .from(".floating-cards-scene", { y: "50vh" }, "<")
        .from(
          ".floating-cards-text-container-1 h1 .word",
          { opacity: 0, yPercent: 100, stagger: 0.05 },
          "<+=75%"
        )
        .from(
          ".floating-cards-text-container-1 .btn-grad",
          { opacity: 0, yPercent: 100 },
          ">"
        );

      // Scroll/pin timeline
      let st = gsap.timeline({
        scrollTrigger: {
          trigger: "#floating-cards-section",
          start: "top top",
          end: stEnd,
          scrub: 0.5,
          pin: "#floating-cards-section",
        },
      });

      st.set(".floating-card", {
        opacity: 1,
      })
        .to(".floating-card", { opacity: 0.1, duration: 1, delay: 1 })
        .to(".floating-cards-text-container-1", { opacity: 0.1 }, "<")
        .to(
          ".floating-card-sticky",
          {
            scale: 1.1,
            opacity: 1,
            duration: 1,
            onStart: () =>
              document
                .getElementById("floating-card-sticky")
                ?.classList.remove("fc-far"),
          },
          "<"
        )
        .to(".floating-card", { opacity: 0, y: "-10vh", duration: 1 })
        .to(
          ".floating-cards-text-container-1",
          { opacity: 0, duration: 1 },
          "<"
        )
        .to(
          ".floating-card-sticky",
          {
            scale: 2,
            x: stickyCardFinalX,
            y: stickyCardFinalY,
            duration: 1,
          },
          "<"
        )
        // prepare text 2
        .set(".floating-cards-text-container-2 h1 .word", {
          opacity: 0,
          yPercent: 80,
        })
        .set(".floating-cards-text-container-2 p .line", {
          opacity: 0,
          yPercent: 80,
        })
        .set(".floating-cards-text-container-2 .elementor-widget-button", {
          opacity: 0,
          yPercent: 80,
        })
        // animate text 2
        .to(".floating-cards-text-container-2 h1 .word", {
          opacity: 1,
          yPercent: 0,
          stagger: 0.05,
        })
        .to(".floating-cards-text-container-2 p .line", {
          opacity: 1,
          yPercent: 0,
          stagger: 0.05,
        })
        .to(".floating-cards-text-container-2 .elementor-widget-button", {
          opacity: 1,
          yPercent: 0,
          stagger: 0.05,
        });
    }

    // --- Mousemove parallax (desktop only) ---
    function onMouseMove(e) {
      let dis = 80;
      let mouseX = (e.clientX / windowX) * dis - dis / 2;
      let mouseY = (e.clientY / windowY) * dis - dis / 2;

      gsap.to(".fc-near", {
        duration: 1,
        x: mouseX,
        y: mouseY,
        ease: "power2.out",
      });
      gsap.to(".fc-far", {
        duration: 1,
        x: mouseX * 0.75,
        y: mouseY * 0.75,
        ease: "power2.out",
      });
    }

    if (window.innerWidth > 768) {
      window._floatingCardsMouseHandler = onMouseMove;
      window.addEventListener("mousemove", onMouseMove);
    }

    // Ensure layout is recalculated
    requestAnimationFrame(() => ScrollTrigger.refresh());
  }
</script>
